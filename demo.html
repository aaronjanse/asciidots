<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>AsciiDots Online Interpreter</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <meta name="author" content="Aaron Janse">

    <style>
        #txtarea {
            height: 225px;
        }

        #out {
            height: 180px;
        }

        #debug_output {
            max-height: none;
        }

        #out, #debug_output {
            white-space: pre;
        }

        #txtarea, #out, #debug_output {
            font-family: monospace;
        }

        body {
            margin: 20px;
        }

        h1,
        button {
            display: inline;
            vertical-align: middle;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        h1 {
            margin-bottom: 1/20px;
            /*margin-top: -5px;*/
        }

        button {
            margin-left: 30px;
            margin-bottom: 10px;
            margin-top: 12px;
        }

        #dropdowndiv{
          /*vertical-align: middle;*/
          width: 250px;
          /*display: inline;*/

          margin-top: 20px;
          margin-bottom: 20px;
        }

        #dropdowndiv button {
          margin: 0;
        }
    </style>
</head>

<body>
    <span>
      <h1>AsciiDots Online Interpreter</h1>
      <button onclick="run()">Run</button>
      <button onclick="stop()">Stop</button>
      <div class="input-group" id='dropdowndiv'>
        <input type="TextBox" id="selectedbox" class="form-control" value="Examples" readonly></input>
        <div class="input-group-btn">
          <button type="button" class="btn dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
    </button>
    <ul id="demolist" class="dropdown-menu">
        <li><a>Hello World</a></li>
        <li><a>Counter</a></li>
        <li><a>Fibonacci</a></li>
        <li><a>Factorial</a></li>
        <li><a>Factor</a></li>
    </ul>
    </div>
    </div>
    </span>
    <div class="form-group" id="txtgroup">
        <textarea class="form-control" placeholder='.-$"Hello, world!"' id="txtarea">.-$"Hello, World!"</textarea>
    </div>

    <div id="debug_output" class="well pre-scrollable" style="background-color: #333;">Debug Output</div>

    <div id="out" class="well pre-scrollable">$ Output</div>

    <!--<div class="form-group">
        <input type="text" class="form-control" id="textin" placeholder="Interactive input">
    </div>-->

    Read about AsciiDots <a href="https://github.com/aaronduino/asciidots">on github</a>

    <script src="ansi_up.js" type="text/javascript"></script>

    <script>
        var params = {};

        if (location.search) {
            var parts = location.search.substring(1).split('&');

            for (var i = 0; i < parts.length; i++) {
                var nv = parts[i].split('=');
                if (!nv[0]) continue;
                params[nv[0]] = nv[1] || true;
            }
        }

        console.log(params.code)

        var default_code = encodeURIComponent('.-$"Hello, World!"')
        params.code = decodeURIComponent(params.code || default_code)

        document.getElementById('txtarea').value = params.code
    </script>

    <script>
        // function str2ab(str) {
        //     var buf = new ArrayBuffer(str.length * 2); // 2 bytes for each char
        //     var bufView = new Uint16Array(buf);
        //     for (var i = 0, strLen = str.length; i < strLen; i++) {
        //         bufView[i] = str.charCodeAt(i);
        //     }
        //     return buf;
        // }

        open = false

        var websocket_url = ''
        if (location.protocol == 'https:') {
          websocket_url = 'wss://'
        } else {
          websocket_url = 'ws://'
        }

        websocket_url += 'asciidots-demo-backend.herokuapp.com'
        // websocket_url = 'ws://localhost:5000/'

        var socket = new WebSocket(websocket_url)

        hasSend = false

        socket.onopen = function() {
            open = true

            setInterval(function() {
                socket.send('update;');
            }, 50);
        };

        var ansi_up = new AnsiUp;
        socket.onmessage = function handle_message(s) {
            if (!hasSend) {
                document.getElementById("out").innerHTML = ""
                hasSend = true
            }

            // console.log(s.data)

            pieces = s.data.split(';')

            if (pieces[0] == 'out') {
              var sections = s.data.split('\n;start_debug;')

              var first_section = sections.shift()

              s.data = first_section

              // Debug data
              var debug_txt = s.data.split(';start_debug;')[1].split(';end_debug')[0]
              // console.log((debug_txt))
              var html = ansi_up.ansi_to_html(debug_txt);

              document.getElementById('debug_output').innerHTML = html

              // Program output
              var out_text = s.data.split(';start_debug;')[1].split(';end_debug;')[1]
              out_text = out_text.replace('\n', '')
              document.getElementById("out").textContent += out_text
              // console.log(s.data);

              document.getElementById("out").scrollTop = document.getElementById("out").scrollHeight;

              if (sections.length > 0) {
                var call_text = 'out;;start_debug;'+sections.join('\n;start_debug;')
                handle_message({data: call_text})
              }
            } else if (pieces[0] == 'input') {
              socket.send(prompt('Please input a value: '));
            } else {
              document.getElementById("out").textContent += s.data
              // console.log(s.data);

              document.getElementById("out").scrollTop = document.getElementById("out").scrollHeight;
            }
        };

        function run() {
            // update url for sharing

            if (open) {
                arg = document.getElementById("txtarea").value
                    // data = new Blob(['run;' + arg], {
                    //     type: 'text/plain'
                    // })
                socket.send('run;' + arg); //.split(/\n/));


                history.pushState(null, null, '?code='+encodeURIComponent(arg));
            } else {
                document.getElementById("out").innerHTML = "Not connected...\nThe backend may not have booted up. Please wait ~5 seconds and reload."
            }
            // alert(document.getElementById("txtarea").value.split(/\n/))
        }

        function stop() {
            if (open) {
                // arg = document.getElementById("txtarea").value
                // data = new Blob(['stop;'], {
                //     type: 'text/plain'
                // })
                socket.send('stop;'); //.split(/\n/));
            } else {
                document.getElementById("out").innerHTML = "Not connected..."
            }
        }

        $(document).on('click', '.dropdown-menu li a', function() {
            val = $(this).html()

            // console.log(val == 'Hello World')

            $('#selectedbox').val(val)

            if (val == 'Hello World') {
              document.getElementById("txtarea").value = `.-$'Hello, World!'`
            } else if (val == 'Counter') {
              document.getElementById("txtarea").value =
`    /1#-.
    |
  /-+-$#\\
  | |   |
 [+]<1#-*
  |     |
  \\--<--/
     |
     0
     #
     |
     .
              `
            } else if (val == 'Fibonacci') {
              document.getElementById("txtarea").value =
`/--#$--\\
|      |
>-*>{+}/
| \\+-/
1  |
#  1
|  #
|  |
.  .
              `
            } else if (val == 'Factorial') {
              document.getElementById("txtarea").value =
` /---------*--~-$#-&
 | /--;---\\| [!]-\\
 | *------++--*#1/
 | | /1#\\ ||
[*]*{-}-*~<+*?#-.
 *-------+-</
 \\-#0----/
              `
            } else if (val == 'Factor') {
              document.getElementById("txtarea").value =
`%!for_in_range.dots f

/.
#
?/\\ #$~\\
*~*{%}//
|\\1#*-*
| .-#1f\\
*--{^}+/&#$~\\
*-#2\\-\\#0*~//
*#1{รท}/  \\//
\\---------/
              `
            }
        });
    </script>
</body>

</html>
